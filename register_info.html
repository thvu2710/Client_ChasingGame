<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>collapsible demo</title>
	<link rel="stylesheet" href="jquery.mobile-1.4.2.min.css">
	<!-- css files -->
	<link rel="stylesheet" href="index.css">
	<link rel="stylesheet" href="info.css">
	<link rel="stylesheet" href="home.css">
	<link rel="stylesheet" href="countdown_timer.css">
	
	<script src="jquery-1.10.2.min.js"></script>
	<script src="jquery.mobile-1.4.2.min.js"></script>
	<script type="text/javascript" charset="utf-8" src="cordova-1.5.0.js"></script>
</head>
<body>
<div data-role=page id=registerer_infor data-back-button=true>
	<div data-role=header data-back-button=true>
		<h1>INFORMATION</h1>
		<a href=register_multiplayer.html rel=external class="ui-btn-left" data-role=button data-icon=back>Back</a>
	</div>
	<div data-role=content>
		<div id="room_info">
		
		</div>
		<ol data-role="listview" data-inset="true">
			
		</ol>
		<br />
		<a href=# data-role=button id=btnRegister>Start Game</a>
	</div>
	<script>
		function parse(val) {
			var result = "Not found",
				tmp = [];
			location.search
			//.replace ( "?", "" ) 
			// this is better, there might be a question mark inside
			.substr(1)
				.split("&")
				.forEach(function (item) {
				tmp = item.split("=");
				if (tmp[0] === val) result = decodeURIComponent(tmp[1]);
			});
			return result;
		}
		var room_id = 0;
		
		var countdownTimer2;
		var countdownTimer3;
		function waitRoomStartFrequentlyChecking() {
			$.ajax({
				 url:"http://localhost:8080/FirstRestWS/rest/webservice/room_started",
				 dataType: 'jsonp',
				 data: {room_id: room_id},
				 success: function(json){
					if (json.statusCode == 1) {
						//change to gameplay_multi page
						clearInterval(countdownTimer2);
						$.mobile.changePage ("gameplay_multi.html");
					} else if (json.statusCode == 0) {
						
					} else if (json.statusCode == 2) {
						clearInterval(countdownTimer2);
					}
				 },
				 error:function(){
					 alert("Error2");
				 }
			});
		};

		function waitEnoughRegisterFrequentlyChecking() {
			$.ajax({
				 url:"http://localhost:8080/FirstRestWS/rest/webservice/enough_register_room_started",
				 dataType: 'jsonp',
				 data: {room_id: room_id},
				 success: function(json){
					var current_room = json.parameters[0];
					if (current_room.register_list.length > 1) {
						$("#btnRegister").text("Start Game");
						$("#btnRegister").removeClass("ui-disabled");
						$("#btnRegister").addClass("ui-enabled");
					} else if (current_room.register_list.length <= 1) {
						$("#btnRegister").text("Not Enough Registers, Cannot Start Game");
						$("#btnRegister").removeClass("ui-enabled");
						$("#btnRegister").addClass("ui-disabled");
					}
					$("ol").text("");
					for (var i = 0; i < current_room.register_list.length; i++) {
						$("ol").append("<li>" + current_room.register_list[i] + "</li>");
					}
					$("ol").listview('refresh');
				 },
				 error:function(){
					 alert("Error2");
				 }
			});
		};
		
		
		function getRoomRegistererByRoomName(room_name, room_name_save) {
			var current_room_name = "";
			if (room_name != "Not found")
				current_room_name = room_name;
			else
				current_room_name = room_name_save;
				
			$.ajax({
				 url:"http://localhost:8080/FirstRestWS/rest/webservice/room_registers",
				 dataType: 'jsonp',
				 data: {room_name:current_room_name},
				 success: function(json){
					var current_room = json.parameters[0];
					room_id = current_room.time_created;
					sessionStorage.setItem('room_name', current_room.room_name);
					sessionStorage.setItem('room_id', room_id);
					$("#room_info").append("<span>Room name: " + current_room.room_name + "</span><br />");
					$("#room_info").append("<span>User created: " + current_room.user_created + "</span><br />");
					$("#room_info").append("<span>Time created: " + new Date(current_room.time_created) + "</span>");
					
					var check = false;
					for (var i = 0; i < current_room.register_list.length; i++) {
						$("ol").append("<li>" + current_room.register_list[i] + "</li>");
						if (current_room.register_list[i] == sessionStorage.getItem("email"))
							check = true;
					}
					$("ol").listview('refresh');
					
					if (check == false) {
						$("#btnRegister").addClass("ui-enabled");
						$("#btnRegister").text("Register this room");
					} else {
						if (current_room.user_created == sessionStorage.getItem("email") && current_room.register_list.length >= 2) {
							$("#btnRegister").addClass("ui-enabled");
							$("#btnRegister").text("Start Game");
						} else if (current_room.user_created == sessionStorage.getItem("email") && current_room.register_list.length < 2) {
							$("#btnRegister").addClass("ui-disabled");
							$("#btnRegister").text("Not Enough Registers, Cannot Start Game");
							countdownTimer3 = setInterval('waitEnoughRegisterFrequentlyChecking()', 5000);
						} else if (current_room.user_created != sessionStorage.getItem("email")) {
							$("#btnRegister").addClass("ui-disabled");
							$("#btnRegister").text("Please wait for the room owner start game...");
							countdownTimer2 = setInterval('waitRoomStartFrequentlyChecking()', 5000);
						}
					}
				 },
				 error:function(){
					 alert("Error");
				 }      
			});
		}
		
		getRoomRegistererByRoomName(parse('room_name'), sessionStorage.getItem('room_name'));
		
		function setRoomStatus(my_room_id, started) {
			var room_info = {
				started: started,
				room_id: my_room_id
			};
			$.ajax({
				 url:"http://localhost:8080/FirstRestWS/rest/webservice/set_room_started",
				 dataType: 'jsonp',
				 data: room_info,
				 success: function(json){
				 //change to gameplay_multi page
				$.mobile.changePage ("gameplay_multi.html");
				 },
				 error:function(){
					 alert("Error");
				 }      
			});
		}
		
		$("#btnRegister").bind ("click", function (event)
		{	
			if ($("#btnRegister").text() == "Start Game") {
				//set current room id
				sessionStorage.setItem("room_id", room_id);
				
				//inform server to change room started status
				setRoomStatus(room_id, 1);
				clearInterval(countdownTimer3);
			} else if ($("#btnRegister").text() == "Register this room") {
				var room_info = {
					email:sessionStorage.getItem("email"),
					room_id: room_id
				};
			
				$.ajax({
					 url:"http://localhost:8080/FirstRestWS/rest/webservice/register_room",
					 dataType: 'jsonp',
					 data: room_info,
					 success: function(json){
						if (json.statusCode == 1) {
							$.mobile.changePage ("#error_infor");
						 } else if(json.statusCode == 2){
							sessionStorage.setItem("room_name", parse('room_name'));
							$.mobile.changePage ("#success_infor");
						 }
					 },
					 error:function(){
						 alert("Error");
					 }      
				});
			} else {
				alert("Invalid status");
			}
		});		
	</script>
</div>
<div data-role=dialog id=error_infor data-back-button=true>
	<div data-role=header data-back-button=true >
		<h1>INFORMATION</h1>
	</div>
	<div data-role=content>
		<p class="text">Register this room Failed </p>
	</div>
</div>
<div data-role=dialog id=success_infor>
	<div data-role=header  >
		<h1>INFORMATION</h1>
	</div>
	<div data-role=content>
		<p class="text">Register this room successfully </p>
		<a href=register_info.html rel=external data-role=button data-icon=back>Back to room info</a>
	</div>
</div>
</body>
</html>